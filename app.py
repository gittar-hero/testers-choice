# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1JWtg1KeUmaRrgwN9NU9oPZKIYJkG3KmC
"""

import os
import cv2
import numpy as np
import io
import shutil
import streamlit as st
from ultralytics import YOLO
from pdf2image import convert_from_path
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.lib.utils import ImageReader
from PIL import Image
import tempfile

# --- ×”×’×“×¨×•×ª ×’×œ×•×‘×œ×™×•×ª ---
# ×”×’×“×¨×•×ª ×¦×‘×¢ (×˜×•×•×— "×’×¡")
LOWER_MARKER_COLOR = np.array([15, 30, 130])
UPPER_MARKER_COLOR = np.array([80, 255, 255])
TEXT_THRESHOLD = 190
MODEL_PATH = "best.pt" # ×”××•×“×œ × ××¦× ×‘××•×ª×” ×ª×™×§×™×™×”

# --- ×¤×•× ×§×¦×™×•×ª ×”×œ×™×‘×” (×œ×œ× ×©×™× ×•×™ ×-Colab) ---

# ×˜×¢×™× ×ª ×”××•×“×œ (×¢× @st.cache_resource ×›×“×™ ×œ×˜×¢×•×Ÿ ×¤×¢× ××—×ª)
@st.cache_resource
def load_yolo_model(model_path):
    if not os.path.exists(model_path):
        st.error(f"×§×•×‘×¥ ×”××•×“×œ ×œ× × ××¦× ×‘× ×ª×™×‘: {model_path}")
        return None
    try:
        model = YOLO(model_path)
        return model
    except Exception as e:
        st.error(f"×©×’×™××” ×‘×˜×¢×™× ×ª ××•×“×œ ×”-YOLO: {e}")
        return None

def check_pdf_for_markers(images, model):
    """
    ×¡×•×¨×§ ××ª ×›×œ ×ª××•× ×•×ª ×”×¢××•×“×™× ×‘×××¦×¢×•×ª ×”××•×“×œ.
    ××—×–×™×¨ True ×× × ××¦× ×œ×¤×—×•×ª ×–×™×”×•×™ ××—×“, ××—×¨×ª False.
    """
    progress_bar = st.progress(0, text="×‘×•×“×§ ××ª ×”××¡××š ×‘×××¦×¢×•×ª ×”××•×“×œ...")

    for i, img_pil in enumerate(images):
        img_cv = cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)
        results = model(img_cv, verbose=False)

        if len(results[0].boxes) > 0:
            st.success(f"â—ï¸ ×–×•×”×” ×¡×™××•×Ÿ ×‘×¢××•×“ {i+1}. ××›×™×Ÿ ××ª ×”×§×•×‘×¥ ×œ× ×™×§×•×™.")
            progress_bar.empty() # × ×§×” ××ª ×”×¤×¨×•×’×¨×¡ ×‘×¨
            return True

        progress_bar.progress((i + 1) / len(images), text=f"×¡×•×¨×§ ×¢××•×“ {i+1}...")

    progress_bar.empty()
    return False

def process_pdf_color_clean(images):
    """
    ×× ×§×” ××ª *×›×œ* ×”×¢××•×“×™× ×‘×××¦×¢×•×ª ×¡×£ ×¦×‘×¢ "×’×¡".
    ××—×–×™×¨ ××ª ×”-PDF ×”× ×§×™ ×‘×ª×•×¨ bytes.
    """
    pdf_bytes_io = io.BytesIO()
    c = canvas.Canvas(pdf_bytes_io, pagesize=A4)
    width_a4, height_a4 = A4

    progress_bar = st.progress(0, text="××¤×¢×™×œ × ×™×§×•×™ ×¦×‘×¢ '×’×¡'...")

    for i, img_pil in enumerate(images):
        img_cv = cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)
        output_img_cv = img_cv.copy()

        hsv_image = cv2.cvtColor(img_cv, cv2.COLOR_BGR2HSV)
        marker_mask = cv2.inRange(hsv_image, LOWER_MARKER_COLOR, UPPER_MARKER_COLOR)
        gray_image = cv2.cvtColor(img_cv, cv2.COLOR_BGR2GRAY)
        _, text_mask = cv2.threshold(gray_image, TEXT_THRESHOLD, 255, cv2.THRESH_BINARY_INV)
        background_only_mask = cv2.bitwise_not(text_mask)
        final_mask_to_clean = cv2.bitwise_and(marker_mask, background_only_mask)
        output_img_cv[final_mask_to_clean == 255] = [255, 255, 255]

        img_pil_cleaned = Image.fromarray(cv2.cvtColor(output_img_cv, cv2.COLOR_BGR2RGB))

        with io.BytesIO() as img_buffer:
            img_pil_cleaned.save(img_buffer, format='PNG')
            img_buffer.seek(0)
            c.drawImage(ImageReader(img_buffer), 0, 0, width=width_a4, height=height_a4, preserveAspectRatio=True)
            c.showPage()

        progress_bar.progress((i + 1) / len(images), text=f"×× ×§×” ×¢××•×“ {i+1}...")

    c.save()
    progress_bar.empty()
    return pdf_bytes_io.getvalue()

# --- ğŸš€ ×‘× ×™×™×ª ×××©×§ ×”××©×ª××© (×”×—×œ×§ ×©×œ Streamlit) ---

st.set_page_config(page_title="×× ×§×” ×”××¨×§×¨×™×", page_icon="ğŸ§¹", layout="centered")

st.title("ğŸ§¹ ×× ×§×” ×”××¨×§×¨×™×")
st.write("×”×›×œ×™ ××¡×™×¨ ×¡×™××•× ×™ ××¨×§×¨ ×¦×‘×¢×•× ×™×™× ××§×‘×¦×™ PDF, ××š ××©××™×¨ ××ª ×”×˜×§×¡×˜ ×§×¨×™×.")

# 1. ×˜×¢×™× ×ª ×”××•×“×œ
model = load_yolo_model(MODEL_PATH)

if model:
    # 2. ×›×¤×ª×•×¨ ×”×¢×œ××ª ×§×•×‘×¥
    uploaded_file = st.file_uploader("×”×¢×œ×” ×§×•×‘×¥ PDF ×œ× ×™×§×•×™:", type=["pdf"])

    if uploaded_file is not None:
        # ×©××•×¨ ××ª ×”×§×•×‘×¥ ×©×”×•×¢×œ×” ×–×× ×™×ª ×›×“×™ ×©-pdf2image ×™×•×›×œ ×œ×§×¨×•× ××•×ª×•
        with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmp_file:
            tmp_file.write(uploaded_file.getvalue())
            tmp_file_path = tmp_file.name

        try:
            with st.spinner("×××™×¨ PDF ×œ×ª××•× ×•×ª... (×–×” ×œ×•×§×— ×¨×’×¢)"):
                images = convert_from_path(tmp_file_path, dpi=200) # dpi × ××•×š ×™×•×ª×¨ ×œ××”×™×¨×•×ª

            # 3. ×‘×“×™×§×” ××§×“×™××” ×¢× ×”××•×“×œ
            is_marked = check_pdf_for_markers(images, model)

            # 4. ×”×—×œ×˜×” ×•× ×™×§×•×™
            if is_marked:
                with st.spinner("×”×¡×™××•× ×™× ×–×•×”×•. ×× ×§×” ××ª ×”×§×•×‘×¥..."):
                    cleaned_pdf_bytes = process_pdf_color_clean(images)

                st.success("âœ… ×”×§×•×‘×¥ × ×•×§×” ×‘×”×¦×œ×—×”!")

                # 5. ×›×¤×ª×•×¨ ×”×•×¨×“×”
                st.download_button(
                    label="â¬‡ï¸ ×”×•×¨×“ ××ª ×”×§×•×‘×¥ ×”× ×§×™",
                    data=cleaned_pdf_bytes,
                    file_name=f"{uploaded_file.name.split('.')[0]}_cleaned.pdf",
                    mime="application/pdf"
                )
            else:
                st.warning("âš ï¸ ×”××¢×¨×›×ª ×œ× ×ª×•××›×ª ×‘×¡×•×’ ×”×¡×™××•×Ÿ ×‘×§×•×‘×¥ ×©×”×ª×§×‘×œ.")

        finally:
            # × ×§×” ××ª ×”×§×•×‘×¥ ×”×–×× ×™
            if os.path.exists(tmp_file_path):
                os.remove(tmp_file_path)
else:
    st.error("×”××¤×œ×™×§×¦×™×” ×‘×˜×¢×™× ×”. ×”××•×“×œ ×¢×“×™×™×Ÿ ×œ× ×–××™×Ÿ.")