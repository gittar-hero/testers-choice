e# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1JWtg1KeUmaRrgwN9NU9oPZKIYJkG3KmC
"""

import os
import cv2
import numpy as np
import io
import shutil
import streamlit as st
from ultralytics import YOLO
from pdf2image import convert_from_path
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.lib.utils import ImageReader
from PIL import Image
import tempfile

# --- 专转 转 ---
# 专转 爪注 ( "住")
LOWER_MARKER_COLOR = np.array([15, 30, 130])
UPPER_MARKER_COLOR = np.array([80, 255, 255])
TEXT_THRESHOLD = 190
MODEL_PATH = "best.pt" #  爪 转 转拽

# --- 驻拽爪转  ( 砖 -Colab) ---

# 注转  (注 @st.cache_resource  注 驻注 转)
@st.cache_resource
def load_yolo_model(model_path):
    if not os.path.exists(model_path):
        st.error(f"拽抓   爪 转: {model_path}")
        return None
    try:
        model = YOLO(model_path)
        return model
    except Exception as e:
        st.error(f"砖 注转  -YOLO: {e}")
        return None

def check_pdf_for_markers(images, model):
    """
    住专拽 转  转转 注 爪注转 .
    专 True  爪 驻转  , 专转 False.
    """
    progress_bar = st.progress(0, text="拽 转 住 爪注转 ...")

    for i, img_pil in enumerate(images):
        img_cv = cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)
        results = model(img_cv, verbose=False)

        if len(results[0].boxes) > 0:
            st.success(f"锔  住 注 {i+1}.  转 拽抓 拽.")
            progress_bar.empty() # 拽 转 驻专专住 专
            return True

        progress_bar.progress((i + 1) / len(images), text=f"住专拽 注 {i+1}...")

    progress_bar.empty()
    return False

def process_pdf_color_clean(images):
    """
    拽 转 ** 注 爪注转 住祝 爪注 "住".
    专 转 -PDF 拽 转专 bytes.
    """
    pdf_bytes_io = io.BytesIO()
    c = canvas.Canvas(pdf_bytes_io, pagesize=A4)
    width_a4, height_a4 = A4

    progress_bar = st.progress(0, text="驻注 拽 爪注 '住'...")

    for i, img_pil in enumerate(images):
        img_cv = cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)
        output_img_cv = img_cv.copy()

        hsv_image = cv2.cvtColor(img_cv, cv2.COLOR_BGR2HSV)
        marker_mask = cv2.inRange(hsv_image, LOWER_MARKER_COLOR, UPPER_MARKER_COLOR)
        gray_image = cv2.cvtColor(img_cv, cv2.COLOR_BGR2GRAY)
        _, text_mask = cv2.threshold(gray_image, TEXT_THRESHOLD, 255, cv2.THRESH_BINARY_INV)
        background_only_mask = cv2.bitwise_not(text_mask)
        final_mask_to_clean = cv2.bitwise_and(marker_mask, background_only_mask)
        output_img_cv[final_mask_to_clean == 255] = [255, 255, 255]

        img_pil_cleaned = Image.fromarray(cv2.cvtColor(output_img_cv, cv2.COLOR_BGR2RGB))

        with io.BytesIO() as img_buffer:
            img_pil_cleaned.save(img_buffer, format='PNG')
            img_buffer.seek(0)
            c.drawImage(ImageReader(img_buffer), 0, 0, width=width_a4, height=height_a4, preserveAspectRatio=True)
            c.showPage()

        progress_bar.progress((i + 1) / len(images), text=f"拽 注 {i+1}...")

    c.save()
    progress_bar.empty()
    return pdf_bytes_io.getvalue()

# ---  转 砖拽 砖转砖 (拽 砖 Streamlit) ---

st.set_page_config(page_title="Testers Choice", page_icon="Ч", layout="centered")

st.title("Testers Choice")
st.write("拽 住 转砖转 拽爪 驻转专 砖  专拽")

# 1. 注转 
model = load_yolo_model(MODEL_PATH)

if model:
    # 2. 驻转专 注转 拽抓
    uploaded_file = st.file_uploader("注砖 注 拽抓 :)", type=["pdf"])

    if uploaded_file is not None:
        # 砖专 转 拽抓 砖注 转  砖-pdf2image  拽专 转
        with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmp_file:
            tmp_file.write(uploaded_file.getvalue())
            tmp_file_path = tmp_file.name

        try:
            with st.spinner("专 PDF 转转... ( 拽 专注)"):
                images = convert_from_path(tmp_file_path, dpi=200) # dpi  转专 专转

            # 3. 拽 拽 注 
            is_marked = check_pdf_for_markers(images, model)

            # 4.  拽
            if is_marked:
                with st.spinner("住 . 拽 转 拽抓..."):
                    cleaned_pdf_bytes = process_pdf_color_clean(images)

                st.success("拽抓 拽 住")

                # 5. 驻转专 专
                st.download_button(
                    label= "拽抓 拽 专",
                    data=cleaned_pdf_bytes,
                    file_name=f"{uploaded_file.name.split('.')[0]}_cleaned.pdf",
                    mime="application/pdf"
                )
            else:
                st.warning("锔 注专转  转转 住 住 拽抓 砖转拽")

        finally:
            # 拽 转 拽抓 
            if os.path.exists(tmp_file_path):
                os.remove(tmp_file_path)
else:
    st.error("驻拽爪 注.  注  ")
